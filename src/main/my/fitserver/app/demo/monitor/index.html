<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
<div style="text-align:right;margin-right:50px;">
    <a target="_blank" href="/">root</a>
    &nbsp;<a target="_blank" href="/_api">api</a>
    &nbsp;<a target="_blank" href="/_cloud?_jsonFormat=true">online</a>
    <a target="_blank" href="/demo/monitor/">monitor</a>
    &nbsp;<a target="_blank" href="https://plugins.jetbrains.com/plugin/22593-fitlang/fitlang">doc</a>
    &nbsp;<a target="_blank" href="https://plugins.jetbrains.com/plugin/22593-fitlang/plugin">plugin</a>
</div>

<h2 style="text-align:center;">FitServer monitor CPU &nbsp;&nbsp;
    <select style="font-size:1.15rem;" onchange="fetch(this.value)">
        <option value="1">1秒</option>
        <option value="5">5秒</option>
        <option value="10">10秒</option>
        <option value="30">30秒</option>
        <option value="60">1分钟</option>
        <option value="300">5分钟</option>
        <option value="600" selected>10分钟</option>
        <option value="1800">30分钟</option>
        <option value="3600">1小钟</option>
        <option value="7200">2小钟</option>
        <option value="18000">5小钟</option>
        <option value="36000">10小钟</option>
        <option value="864000">1天</option>
        <option value="604800">1周</option>
        <option value="2592000">1月</option>
        <option value="31536000">1年</option>
    </select></h2>

<div>
    <canvas id="myChart"></canvas>
</div>

<script src="chart-3.9.1.js"></script>
<script>
    var httpRequest = new XMLHttpRequest();

    function request(action, url, input, callback) {
        httpRequest.open(action, url, true);
        httpRequest.onreadystatechange = function(message) {
            if (httpRequest.readyState == 4 && httpRequest.status == 200) {
                callback(httpRequest.responseText);
            }
        };
        var body = null;
        if(typeof(input)==="string") {
            body = input;
        } else if(typeof(input)==="object") {
            body = JSON.stringify(input);
        }
        httpRequest.send(body);
    }
</script>
<script>

    const ctx = document.getElementById('myChart');

    const colorMap = {
        "free": 'rgb(0, 200, 0)',
        "used": 'rgb(220, 0, 0)',
        "user": 'rgb(120, 0, 0)',
        "sys": 'rgb(150, 100, 0)',
        "wait": 'rgb(200, 0, 50)',
    };
    function addPoint(labels, datasets, pointData) {
        for(var i=0; i<labels.length; i++) {
            if(datasets[i] == null) {
                datasets[i] = {};
                datasets[i].data = [];
            }
            datasets[i].label = labels[i];
            datasets[i].data.push(pointData[labels[i]]);

            datasets[i].borderColor = colorMap[labels[i]];
        }
    }

    var myChat;
    function fetch(second) {
        var url = "getMonitorData.fit?second=" + second
        request("POST", url, "", function(body){
           var result = JSON.parse(body);

           var data =  {labels:[],datasets:[]};
           for(var i=0; i<result.cpu.length; i++) {
               data.labels[i] = result.cpu[i].timestampShow;
               addPoint(["used", "free", "user", "sys", "wait"], data.datasets, result.cpu[i]);
           }

           if(myChat instanceof Chart){
               myChat.destroy();
           }
           myChat = new Chart(ctx, {
                type: 'line',
                data: data,
            });
        });
    }

    fetch(600);
</script>

</body>
</html>